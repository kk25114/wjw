# 身份证号码15位转18位转换说明文档

## 1. 结果示例（使用步骤5）

处理15位的身份证号码，转换为18位的身份证号码。
原始数据证件类型为身份证，15位或18位，年份和行政区域错误，如果证件类型相同，排除其它类型，格式一致，
判断为原始数据错误，但证件号唯一，默认处理
初步处理15，18位身份证卫考护考，[2004-2024年]
15位数身份证，年份补全为19，2000年以后，可能用老身份证报名，00，到24年补20


参考链接：
- http://itxp365.com/Tool/IDNo15To18.aspx
- https://juejin.cn/post/7044065410123410734

早期的身份证号码即第一代身份证，为15位，1999年开始更名为公民身份证号码，即第二代身份证，为18位，且终身不变。
年份通常补充19，2000年以后，可能用老身份证报名，需要补20

| 原始身份证号 | 转换后身份证号 |
|------------|--------------|
| 130503670401001 | 130503196704010016 |
| 13050319900301001X | 13050319900301001X |
| 110105901231067 | 110105199012310676 |
| 320311770706001 | 320311197707060018 |
| 610104620411123 | 610104196204111231 |
| 440102199901010034 | 440102199901010034 |
| 44010219820606053X | 44010219820606053X |
| 511027840506030 | 511027198405060309 |
| 123456789012345 | 123456197890123454 |
| 320311198504101234 | 320311198504101234 |

## 2. 身份证15位与18位的区别

### 1. 长度不同
- 15位身份证：共15个数字
- 18位身份证：前17位为数字，最后1位可能是数字或字母"X"

### 2. 出生日期标识不同
- 15位身份证：第7-12位为出生日期(YYMMDD)，只能表示年份后两位
- 18位身份证：第7-14位为出生日期(YYYYMMDD)，能完整表示四位年份

### 3. 校验位
- 15位身份证：无校验位
- 18位身份证：第18位为校验位，按国家标准算法计算，可取值0-9或"X"

### 4. 转换
- 将出生年份从2位扩展至4位(通常在前面补"19")
- 计算并追加校验位，形成18位

## 3. 转换处理流程

### 1. 判断身份证号长度是否为15位

### 2. 15位号码转换步骤
- 拆分前6位(地址码)
- 拆分中间6位(出生日期YYMMDD) 
- 拆分顺序码(最后3位)
- 年份前补"19"组成8位生日(YYYYMMDD)
- 拼接前17位
- 计算校验位
- 拼接成完整18位

### 3. 18位号码不变

## 4. 校验位计算规则

### 1. 权重因子对照表

| 位数(i) | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 |
|---------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|----| 
| 因子(Wi) | 7 | 9 | 10| 5 | 8 | 4 | 2 | 1 | 6 | 3  | 7  | 9  | 10 | 5  | 8  | 4  | 2  |

### 2. 计算步骤
- 计算加权和：S = A1×W1 + A2×W2 + ... + A17×W17
- 计算余数：mod = S mod 11
- 根据余数查表获得校验位：

| 余数 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |
|------|---|---|---|---|---|---|---|---|---|---|----| 
| 校验位 | 1 | 0 | X | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 |

注：若计算结果为10，则校验位为"X"，否则为对应数字。

## 5. 转换Hive-SQL示例


对于15位身份证号码转18位时,年份补全规则如下:

1. 如果出生年份(YY)在[00,24]之间,补'20'
2. 其他情况补'19'

```sql
-- 比较5增加了年份补全的逻辑
-- 1. 创建一张新表，用于存储转换结果
CREATE TABLE IF NOT EXISTS transformed_table AS
WITH base AS (
    SELECT
        sfzh,
        LENGTH(sfzh) AS len_sfzh,
        
        -- 2. 如果是15位，则先拼接成17位
        -- 其中“年份”需要根据第7-8位判断，是补 '19' 还是补 '20'
        CASE WHEN LENGTH(sfzh) = 15
             THEN CONCAT(
                   SUBSTR(sfzh, 1, 6),   -- 地区码
                   
                   CASE 
                     WHEN SUBSTR(sfzh, 7, 2)  BETWEEN '00' AND '24' 
                          THEN '20'      -- 如果出生年份(YY)在[00,24]之间，补'20'
                     ELSE '19'          -- 否则补'19'
                   END,
                   
                   SUBSTR(sfzh, 7, 6),   -- 原来的出生日期部分(YYMMDD)
                   SUBSTR(sfzh, 13, 3)   -- 顺序码3位
                  )
             ELSE NULL  -- 如果不是15位，就先记为NULL，在后面直接保留
        END AS sfzh17
    FROM origin_table
)

SELECT
    sfzh,
    
    CASE 
       WHEN len_sfzh = 15 THEN
         -- 3. 对上面拼的17位计算校验位，然后拼成18位身份证
         CONCAT(
           sfzh17,
           CASE (
             (
               CAST(SUBSTR(sfzh17, 1, 1) AS INT)  * 7 +
               CAST(SUBSTR(sfzh17, 2, 1) AS INT)  * 9 +
               CAST(SUBSTR(sfzh17, 3, 1) AS INT)  * 10 +
               CAST(SUBSTR(sfzh17, 4, 1) AS INT)  * 5 +
               CAST(SUBSTR(sfzh17, 5, 1) AS INT)  * 8 +
               CAST(SUBSTR(sfzh17, 6, 1) AS INT)  * 4 +
               CAST(SUBSTR(sfzh17, 7, 1) AS INT)  * 2 +
               CAST(SUBSTR(sfzh17, 8, 1) AS INT)  * 1 +
               CAST(SUBSTR(sfzh17, 9, 1) AS INT)  * 6 +
               CAST(SUBSTR(sfzh17, 10, 1) AS INT) * 3 +
               CAST(SUBSTR(sfzh17, 11, 1) AS INT) * 7 +
               CAST(SUBSTR(sfzh17, 12, 1) AS INT) * 9 +
               CAST(SUBSTR(sfzh17, 13, 1) AS INT) * 10 +
               CAST(SUBSTR(sfzh17, 14, 1) AS INT) * 5 +
               CAST(SUBSTR(sfzh17, 15, 1) AS INT) * 8 +
               CAST(SUBSTR(sfzh17, 16, 1) AS INT) * 4 +
               CAST(SUBSTR(sfzh17, 17, 1) AS INT) * 2
             ) % 11
           )
           WHEN 0  THEN '1'
           WHEN 1  THEN '0'
           WHEN 2  THEN 'X'
           WHEN 3  THEN '9'
           WHEN 4  THEN '8'
           WHEN 5  THEN '7'
           WHEN 6  THEN '6'
           WHEN 7  THEN '5'
           WHEN 8  THEN '4'
           WHEN 9  THEN '3'
           WHEN 10 THEN '2'
           END
         )
       ELSE
         -- 如果身份证号不是15位，则直接保留原值
         sfzh
    END AS sfzh_18

FROM base;